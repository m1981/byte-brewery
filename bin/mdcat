#!/bin/bash

set -euo pipefail

# Help Handler
if [[ "${1:-}" == "-h" || "${1:-}" == "--help" ]]; then
    echo "Usage: mdcat [-o output_file] file1 [file2 ...]"
    echo "Concatenates files into markdown code blocks."
    exit 0
fi

# Initialize variables
OUTPUT_FILE=""

# Function to resolve absolute path
get_abs_path() {
    local path="$1"
    python3 -c "import os, sys; print(os.path.abspath(sys.argv[1]))" "$path"
}

# Parse arguments
while getopts ":o:" opt; do
  case ${opt} in
    o)
      OUTPUT_FILE=$(get_abs_path "$OPTARG")
      ;;
    \?)
      echo "Invalid option: -$OPTARG" >&2
      exit 1
      ;;
    :)
      echo "Option -$OPTARG requires an argument." >&2
      exit 1
      ;;
  esac
done
shift $((OPTIND -1))

# Handle Output Redirection
if [ -n "$OUTPUT_FILE" ]; then
    : > "$OUTPUT_FILE" # Truncate
    exec 1> "$OUTPUT_FILE" # Redirect stdout
fi

# Function to safely handle each file
handle_file() {
    local file="$1"

    if [ ! -f "$file" ]; then
        echo "Warning: File '$file' not found. Skipping." >&2
        return
    fi

    # Check against the output file to prevent loops
    if [ -n "$OUTPUT_FILE" ]; then
        local current_abs_path
        current_abs_path=$(get_abs_path "$file")

        if [ "$current_abs_path" == "$OUTPUT_FILE" ]; then
            echo "Skipping output file: $file" >&2
            return
        fi
    fi

    echo "File: $file"
    echo '```'
    cat "$file"
    echo -e "\n"
    echo '```'
    echo -e "\n"
}

if [ "$#" -eq 0 ]; then
  echo "Usage: mdcat [-o output_file] file1 [file2 ...]" >&2
  exit 1
fi

for file in "$@"; do
    handle_file "$file"
done

echo "Concatenation complete." >&2